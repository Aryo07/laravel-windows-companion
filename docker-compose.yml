version: "3.9"

name: laravel-infra

services:
  # =========================
  # MySQL 8 (Default)
  # =========================
  mysql:
    build: ./docker/mysql
    container_name: mysql8
    restart: unless-stopped
    ports:
      - "${MYSQL_PORT:-3306}:3306" # Jika port tidak diisi di .env, maka akan menggunakan port 3306
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-root} # Jika password tidak diisi di .env, maka akan menggunakan password root
      MYSQL_DATABASE: ${MYSQL_DATABASE:-laravel} # Jika database tidak diisi di .env, maka akan menggunakan database laravel
      MYSQL_USER: ${MYSQL_USER:-laravel} # Jika user tidak diisi di .env, maka akan menggunakan user laravel
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-secret} # Jika password tidak diisi di .env, maka akan menggunakan password secret
      TZ: Asia/Jakarta
    volumes:
      - mysql8_data:/var/lib/mysql
    command: --default-authentication-plugin=mysql_native_password
    networks:
      - laravel
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # =========================
  # MariaDB 10.11 (LTS)
  # =========================
  mariadb:
    build: ./docker/mariadb
    container_name: mariadb1011
    restart: unless-stopped
    ports:
      - "${MARIADB_PORT:-3307}:3306" # Jika port tidak diisi di .env, maka akan menggunakan port 3307
    environment:
      MARIADB_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-root} # Jika password tidak diisi di .env, maka akan menggunakan password root
      MARIADB_DATABASE: ${MYSQL_DATABASE:-laravel} # Jika database tidak diisi di .env, maka akan menggunakan database laravel
      MARIADB_USER: ${MYSQL_USER:-laravel} # Jika user tidak diisi di .env, maka akan menggunakan user laravel
      MARIADB_PASSWORD: ${MYSQL_PASSWORD:-secret} # Jika password tidak diisi di .env, maka akan menggunakan password secret
      TZ: Asia/Jakarta
    volumes:
      - mariadb1011_data:/var/lib/mysql
    networks:
      - laravel
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # =========================
  # Redis
  # =========================
  redis:
    image: docker.io/library/redis:7-alpine
    container_name: redis
    restart: unless-stopped
    ports:
      - "${REDIS_PORT:-6379}:6379" # Jika port tidak diisi di .env, maka akan menggunakan port 6379
    # Batasan Opsional (Hapus komentar di blok perintah dengan HATI-HATI jika diperlukan pindahkan ke dalam command atur sesuai kebutuhan):
    # --maxmemory 512mb
    # --maxmemory-policy allkeys-lru
    command: >
      redis-server
      --appendonly yes
      --appendfsync everysec
    volumes:
      - redis_data:/data
    networks:
      - laravel
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # =========================
  # Mailpit (SMTP Catcher)
  # =========================
  mailpit:
    image: docker.io/axllent/mailpit
    container_name: mailpit
    restart: unless-stopped
    ports:
      - "${MAILPIT_SMTP_PORT:-1025}:1025" # Jika port tidak diisi di .env, maka akan menggunakan port 1025 (SMTP)
      - "${MAILPIT_WEB_PORT:-8025}:8025" # Jika port tidak diisi di .env, maka akan menggunakan port 8025 (Web UI)
    environment:
      MP_SMTP_AUTH_ACCEPT_ANY: "true"
      MP_SMTP_AUTH_ALLOW_INSECURE: "true"
    networks:
      - laravel
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # =========================
  # Nexterm (Web Terminal)
  # =========================
  nexterm:
    image: germannewsmaker/nexterm:latest
    container_name: nexterm
    restart: unless-stopped
    ports:
      - "${NEXTERM_PORT:-6989}:6989" # Jika port tidak diisi di .env, maka akan menggunakan port 6989
    environment:
      - ENCRYPTION_KEY=${NEXTERM_ENCRYPTION_KEY}
    volumes:
      - nexterm_data:/app/data
    networks:
      - laravel
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# =========================
# Networks
# =========================
networks:
  laravel:
    driver: bridge

# =========================
# Volumes
# =========================
volumes:
  mysql8_data:
  mariadb1011_data:
  redis_data:
  nexterm_data:
